\section{Gradient computation}

We'd like to compute $ \nabla \risk ( h ) $ for $ h \in L^{ 2 } ( X ) $.
We start by computing the directional derivative of $ \risk $ at $ h $ in the direction $ f $, denoted by $ D \risk [ h ] ( f ) $:
\begin{align*}
    D \risk [ h ] ( f )
    &= \lim\limits_{ \delta \to 0 } \frac{ 1 }{ \delta } \left[
        \risk ( h + \delta f ) - \risk ( f )
    \right] \\
    &= \lim\limits_{ \delta \to 0 } \frac{ 1 }{ \delta } \mean \left[
        \ell ( r_{ 0 } ( Z ), \meanop [ h + \delta f ] ( Z ) )
        -
        \ell ( r_{ 0 } ( Z ), \meanop [ h ] ( Z ) )
    \right] \\
    &= \lim\limits_{ \delta \to 0 } \frac{ 1 }{ \delta } \mean \left[
        \ell ( r_{ 0 } ( Z ), \meanop [ h ] ( Z ) + \delta \meanop [ f ] ( Z ) )
        -
        \ell ( r_{ 0 } ( Z ), \meanop [ h ] ( Z ) )
    \right] \\
    \begin{split}
        &= \lim\limits_{ \delta \to 0 } \frac{ 1 }{ \delta } \mean \Biggl[
            \delta \partial_{ 2 } \ell ( r_{ 0 } ( Z ), \meanop [ h ] ( Z ) ) \cdot \meanop [ f ] ( Z ) \\
        &\hspace{2cm}+ \frac{ \delta^2 }{ 2 } \partial_{ 2 }^2 \ell ( r_{ 0 } ( Z ) , \meanop [ h + \theta f ] ( Z ) ) \cdot \meanop [ f ] ( Z )^2
        \Biggr]
    \end{split} \\
    \begin{split}
        &= \mean \left[
            \partial_{ 2 } \ell ( r_{ 0 } ( Z ), \meanop [ h ] ( Z ) ) \cdot \meanop [ f ] ( Z )
        \right] \\
        &\hspace{2cm}+ \lim\limits_{ \delta \to 0 } \mean \Biggl[
            \frac{ \delta }{ 2 } \partial_{ 2 }^2 \ell ( r_{ 0 } ( Z ) , \meanop [ h + \theta f ] ( Z ) ) \cdot \meanop [ f ] ( Z )^2
        \Biggr]
    \end{split} \\
    &= \mean \left[
        \partial_{ 2 } \ell ( r_{ 0 } ( Z ), \meanop [ h ] ( Z ) ) \cdot \meanop [ f ] ( Z )
    \right]
,\end{align*}
where $ \theta \in \R $ is due to Taylor's formula.
The last step is then due to Proposition \ref{prop: loss properties}.\ref{bounded second derivative}.

We can in fact expand the calculation a bit more, as follows:
\begin{align*}
    D \risk [ h ] ( f )
    &= \mean \left[
        \partial_{ 2 } \ell ( r_{ 0 } ( Z ), \meanop [ h ] ( Z ) ) \cdot \meanop [ f ] ( Z )
    \right] \\
    &= \dotprod{ \partial_{ 2 } \ell ( r_{ 0 } ( \cdot ), \meanop [ h ] ( \cdot ) ), \meanop [ f ] }_{ L^{ 2 } ( Z ) } \\
    &= \dotprod{ \meanop^{ * } [ \partial_{ 2 } \ell ( r_{ 0 } ( Z ), \meanop [ h ] ( \cdot ) ) ], f }_{ L^{ 2 } ( X ) }
.\end{align*}
This shows that $ \risk $ is Gateux-differentiable, with Gateux derivative at $ h $ given by
\begin{equation*}
    D \risk [ h ] = \meanop^{ * } [ \partial_{ 2 } \ell ( r_{ 0 } ( \cdot ), \meanop [ h ] ( \cdot ) ) ]
.\end{equation*}
By Proposition \ref{prop: loss properties}.\ref{continuous composition} we have that $ h \mapsto D \risk [ h ] $ is a continuous mapping from $ L^{ 2 } ( X ) $ to $ L^{ 2 } ( X ) $, which implies that $ \risk $ is also Fr√©chet-differentiable, and both derivatives coincide.\improvement{Cite a reference for this.}
Therefore,
\begin{equation*}
   \nabla \risk ( h ) = \meanop^{ * } [ \partial_{ 2 } \ell ( r_{ 0 } ( \cdot ), \meanop [ h ] ( \cdot ) ) ]  
.\end{equation*}
